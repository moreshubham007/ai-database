{% extends 'base.html' %}

{% block title %}Dashboard - Company Database{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="row">
        <div class="col s12">
            <div class="card gradient-card">
                <div class="card-content white-text">
                    <div class="row mb-0">
                        <div class="col s12 m6">
                            <h4><i class="material-icons left">dashboard</i> Company Dashboard</h4>
                            <p>Manage and analyze your company database</p>
                        </div>
                        <div class="col s12 m6 right-align">
                            <div class="dashboard-stats">
                                <div class="stat-item">
                                    <span class="stat-value">{{ total_companies }}</span>
                                    <span class="stat-label">Total Companies</span>
                                </div>
                                {% if search_query %}
                                <div class="stat-item">
                                    <span class="stat-value">{{ companies|length }}</span>
                                    <span class="stat-label">Matching Results</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">search</i>Search Companies
                    </span>
                    
                    <form method="GET" action="{{ url_for('dashboard') }}">
                        <div class="row mb-0">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">search</i>
                                <input id="search" type="text" name="search" value="{{ search_query }}" class="validate">
                                <label for="search" {% if search_query %}class="active"{% endif %}>Search Query</label>
                            </div>
                            <div class="input-field col s12 m3">
                                <select name="field" id="field">
                                    <option value="all" {% if search_field == 'all' %}selected{% endif %}>All Fields</option>
                                    <option value="name" {% if search_field == 'name' %}selected{% endif %}>Name</option>
                                    <option value="website" {% if search_field == 'website' %}selected{% endif %}>Website</option>
                                    <option value="products" {% if search_field == 'products' %}selected{% endif %}>Products</option>
                                    <option value="services" {% if search_field == 'services' %}selected{% endif %}>Services</option>
                                    <option value="location" {% if search_field == 'location' %}selected{% endif %}>Location</option>
                                    <option value="keyword" {% if search_field == 'keyword' %}selected{% endif %}>Keyword</option>
                                </select>
                                <label>Search In</label>
                            </div>
                            <div class="input-field col s12 m3">
                                <select name="per_page" id="per_page" onchange="this.form.submit()">
                                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10 per page</option>
                                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                                    <option value="all" {% if per_page == "all" %}selected{% endif %}>Show All</option>
                                </select>
                                <label>Items Per Page</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col s12">
                                <button class="btn waves-effect waves-light" type="submit">
                                    <i class="material-icons left">search</i> Search
                                </button>
                                {% if search_query %}
                                    <a href="{{ url_for('dashboard', per_page=per_page) }}" class="btn waves-effect waves-light red lighten-1">
                                        <i class="material-icons left">clear</i> Clear
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Actions Toolbar -->
    <div id="bulk-actions-toolbar" class="card-panel blue-grey lighten-5" style="display: none; margin-top: 10px;">
        <div class="row valign-wrapper mb-0">
            <div class="col s6">
                <span id="selected-count" class="flow-text">0 companies selected</span>
            </div>
            <div class="col s6 right-align">
                <div class="dropdown-trigger btn" data-target="bulk-actions-dropdown">
                    <i class="material-icons left">build</i>Bulk Actions<i class="material-icons right">arrow_drop_down</i>
                </div>
                <ul id="bulk-actions-dropdown" class="dropdown-content">
                    <li><a href="#bulk-ai-update-modal" class="modal-trigger"><i class="material-icons left">update</i>Update with AI</a></li>
                    <li><a href="#bulk-delete-modal" class="modal-trigger"><i class="material-icons left">delete</i>Delete</a></li>
                    <li><a href="#!" id="download-selected-csv"><i class="material-icons left">file_download</i>Download CSV</a></li>
                    <li class="divider"></li>
                    <li><a href="#" id="bulk-select-all"><i class="material-icons left">select_all</i>Select All</a></li>
                    <li><a href="#" id="bulk-deselect-all"><i class="material-icons left">clear_all</i>Deselect All</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Results Summary -->
    <div class="row">
        <div class="col s12">
            <div class="chip">
                <i class="material-icons left">info</i>
                Showing {{ companies|length }} of {{ total_companies }} companies
                {% if search_query %}
                    matching "{{ search_query }}" in {{ "all fields" if search_field == "all" else search_field }}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Companies Table -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">business</i>Companies
                    </span>
                    
                    <div class="responsive-table">
                        <table class="striped highlight">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <label>
                                            <input type="checkbox" id="select-all-checkbox" class="filled-in" />
                                            <span></span>
                                        </label>
                                    </th>
                                    <th>Name</th>
                                    <th>Website</th>
                                    <th>LinkedIn</th>
                                    <th>Products</th>
                                    <th>Services</th>
                                    <th>Location</th>
                                    <th>Keyword</th>
                                    <th class="center-align">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr>
                                    <td>
                                        <label>
                                            <input type="checkbox" class="filled-in company-checkbox" data-id="{{ company._id }}" />
                                            <span></span>
                                        </label>
                                    </td>
                                    <td>{{ company.name }}</td>
                                    <td>
                                        {% if company.website %}
                                            <a href="{{ company.website }}" target="_blank" class="truncate">
                                                <i class="material-icons left">language</i>Website
                                            </a>
                                        {% else %}
                                            <span class="grey-text">Not specified</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if company.linkedin_url %}
                                            <a href="{{ company.linkedin_url }}" target="_blank" class="truncate">
                                                <i class="material-icons left">link</i>LinkedIn
                                            </a>
                                        {% else %}
                                            <span class="grey-text">Not specified</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ company.products or 'Not specified' }}</td>
                                    <td>{{ company.services or 'Not specified' }}</td>
                                    <td>{{ company.location or 'Not specified' }}</td>
                                    <td>{{ company.keyword or 'Not specified' }}</td>
                                    <td class="center-align">
                                        <div class="action-buttons">
                                            <a href="#company-detail-modal" class="btn-floating btn-small waves-effect waves-light blue tooltipped modal-trigger view-company" 
                                               data-id="{{ company._id }}" data-position="top" data-tooltip="View Details">
                                                <i class="material-icons">visibility</i>
                                            </a>
                                            <a href="#ai-update-modal" class="btn-floating btn-small waves-effect waves-light green tooltipped modal-trigger update-company" 
                                               data-id="{{ company._id }}" data-name="{{ company.name }}" data-website="{{ company.website }}" 
                                               data-position="top" data-tooltip="Update with AI">
                                                <i class="material-icons">update</i>
                                            </a>
                                            <a href="{{ url_for('edit_company', company_id=company._id) }}" class="btn-floating btn-small waves-effect waves-light orange tooltipped" 
                                               data-position="top" data-tooltip="Edit">
                                                <i class="material-icons">edit</i>
                                            </a>
                                            <a href="{{ url_for('delete_company', company_id=company._id) }}" class="btn-floating btn-small waves-effect waves-light red tooltipped" 
                                               data-position="top" data-tooltip="Delete" onclick="return confirm('Are you sure you want to delete this company?');">
                                                <i class="material-icons">delete</i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="center-align">
                                        <div class="empty-state">
                                            <i class="material-icons large">search_off</i>
                                            <p>No companies found{% if search_query %} matching your search criteria{% endif %}.</p>
                                            <a href="{{ url_for('add_company') }}" class="btn waves-effect waves-light">
                                                <i class="material-icons left">add_business</i>Add Company
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if total_pages > 1 %}
                    <div class="pagination-container center-align">
                        <ul class="pagination">
                            <li class="{{ 'disabled' if current_page == 1 else 'waves-effect' }}">
                                <a href="{{ url_for('dashboard', page=current_page-1, search=search_query, field=search_field, per_page=per_page) if current_page > 1 else '#' }}">
                                    <i class="material-icons">chevron_left</i>
                                </a>
                            </li>
                            
                            {% for page in range(1, total_pages + 1) %}
                                {% if page == current_page %}
                                    <li class="active"><a href="#">{{ page }}</a></li>
                                {% else %}
                                    <li class="waves-effect">
                                        <a href="{{ url_for('dashboard', page=page, search=search_query, field=search_field, per_page=per_page) }}">
                                            {{ page }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            <li class="{{ 'disabled' if current_page == total_pages else 'waves-effect' }}">
                                <a href="{{ url_for('dashboard', page=current_page+1, search=search_query, field=search_field, per_page=per_page) if current_page < total_pages else '#' }}">
                                    <i class="material-icons">chevron_right</i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this card to test the Bedrock link directly -->
<div class="row">
    <div class="col s12">
        <div class="card blue">
            <div class="card-content white-text">
                <span class="card-title">Admin Links (Debug)</span>
                <p>Direct links to admin features for testing:</p>
            </div>
            <div class="card-action">
                <a href="{{ url_for('admin_bp.admin_dashboard') }}" class="white-text">Admin Dashboard</a>
                <a href="{{ url_for('admin_bp.admin_bedrock') }}" class="white-text">AWS Bedrock Config</a>
                <a href="{{ url_for('admin_bp.admin_test') }}" class="white-text">Admin Test</a>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for AI updates right before the end of your content block -->
<div id="ai-update-modal" class="modal">
    <div class="modal-content">
        <h4>Update Company with AI</h4>
        <p>Use AI to automatically update company information from their website.</p>
        
        <div class="row">
            <div class="input-field col s12">
                <select id="update-field-select">
                    <option value="all" selected>All Missing Fields</option>
                    <option value="all_override">All Fields (Override)</option>
                    <option value="name">Company Name</option>
                    <option value="products">Products</option>
                    <option value="services">Services</option>
                    <option value="location">Location</option>
                    <option value="description">Description</option>
                    <option value="industry">Industry</option>
                    <option value="keyword">Keywords</option>
                    <option value="linkedin_url">LinkedIn URL</option>
                </select>
                <label>Fields to Update</label>
                <span class="helper-text">Select "All Fields (Override)" to update all fields regardless of existing values</span>
            </div>
            
            <div class="input-field col s12">
                <input type="text" id="company-website-input" class="validate">
                <label for="company-website-input">Company Website</label>
                <span class="helper-text">Will be used to gather information</span>
            </div>
        </div>
        
        <div class="progress" id="update-progress" style="display: none;">
            <div class="indeterminate"></div>
        </div>
        
        <div id="update-result" style="display:none;">
            <div class="card-panel green lighten-4 success-result" style="display:none;">
                <i class="material-icons left">check_circle</i>
                <span class="result-message"></span>
                <div class="linkedin-badge" style="display:none;">
                    <span class="new badge blue" data-badge-caption="LinkedIn data used"></span>
                </div>
                <p class="updated-fields">
                    <span class="badge blue white-text name-badge" style="display:none;">Name</span>
                    <span class="badge blue white-text products-badge" style="display:none;">Products</span>
                    <span class="badge blue white-text services-badge" style="display:none;">Services</span>
                    <span class="badge blue white-text location-badge" style="display:none;">Location</span>
                    <span class="badge blue white-text description-badge" style="display:none;">Description</span>
                    <span class="badge blue white-text industry-badge" style="display:none;">Industry</span>
                    <span class="badge blue white-text keyword-badge" style="display:none;">Keywords</span>
                    <span class="badge blue white-text linkedin-badge" style="display:none;">LinkedIn URL</span>
                </p>
            </div>
            <div class="card-panel red lighten-4 error-result" style="display:none;">
                <i class="material-icons left">error</i>
                <span class="result-message"></span>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-light btn-flat">Cancel</a>
        <a href="#!" class="waves-effect waves-light btn blue" id="start-ai-update">
            <i class="material-icons left">refresh</i>Update with AI
        </a>
    </div>
</div>

<!-- Add this new modal for bulk AI updates right after the existing modals -->
<div id="bulk-ai-update-modal" class="modal">
  <div class="modal-content">
    <h4>Bulk Update Companies with AI</h4>
    <p>Use AI to automatically update information for the selected companies from their websites.</p>
    
    <div class="row">
      <div class="input-field col s12">
        <select id="bulk-update-field-select">
          <option value="all" selected>All Missing Fields</option>
          <option value="all_override">All Fields (Override)</option>
          <option value="name">Company Name</option>
          <option value="products">Products</option>
          <option value="services">Services</option>
          <option value="location">Location</option>
          <option value="description">Description</option>
          <option value="industry">Industry</option>
          <option value="keyword">Keywords</option>
          <option value="linkedin_url">LinkedIn URL</option>
        </select>
        <label>Fields to Update</label>
        <span class="helper-text">Select "All Fields (Override)" to update all fields regardless of existing values</span>
      </div>
      
      <div class="input-field col s12">
        <select id="bulk-update-provider-select">
          {% if llm_providers %}
            {% for provider in llm_providers %}
              <option value="{{ provider }}">{{ provider|capitalize }}</option>
            {% endfor %}
          {% else %}
            <option value="bedrock" selected>AWS Bedrock</option>
          {% endif %}
        </select>
        <label>AI Provider</label>
      </div>
    </div>
    
    <div class="progress" id="bulk-update-progress" style="display: none;">
      <div class="indeterminate"></div>
    </div>
    
    <div class="card-panel" id="bulk-update-result" style="display: none;"></div>
    <div id="bulk-update-details" style="display: none;">
      <h5>Processing Status</h5>
      <ul class="collection" id="bulk-update-status-list">
        <!-- Status items will be added here -->
      </ul>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-light btn-flat">Cancel</a>
    <a href="#!" class="waves-effect waves-light btn blue" id="start-bulk-ai-update">
      <i class="material-icons left">refresh</i>Update with AI
    </a>
  </div>
</div>

<!-- Add bulk delete confirmation modal -->
<div id="bulk-delete-modal" class="modal">
  <div class="modal-content">
    <h4>Delete Multiple Companies</h4>
    <p>Are you sure you want to delete the selected companies? This action cannot be undone.</p>
    <p id="bulk-delete-count" class="flow-text"></p>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-light btn-flat">Cancel</a>
    <a href="#!" class="waves-effect waves-light btn red" id="confirm-bulk-delete">
      <i class="material-icons left">delete_forever</i>Delete Companies
    </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips with a slightly longer delay
        var tooltipElems = document.querySelectorAll('.tooltipped');
        var tooltipInstances = M.Tooltip.init(tooltipElems, {
            enterDelay: 200,
            exitDelay: 100
        });
        
        // Add hover effect to table rows
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f5f5f5';
                this.style.transition = 'background-color 0.2s ease';
            });
            
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
        
        // Add animation to stats
        const statValues = document.querySelectorAll('.stat-value');
        statValues.forEach(stat => {
            const finalValue = parseInt(stat.textContent);
            let currentValue = 0;
            const duration = 1000; // 1 second
            const increment = Math.ceil(finalValue / (duration / 20));
            
            const counter = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    clearInterval(counter);
                    stat.textContent = finalValue;
                } else {
                    stat.textContent = currentValue;
                }
            }, 20);
        });
        
        // Keep the existing JavaScript for bulk actions, etc.
    });
</script>
{% endblock %}

{% block styles %}
<style>
    .dashboard-container {
        padding-top: 20px;
    }
    
    .gradient-card {
        background: linear-gradient(45deg, #1976d2, #64b5f6);
        border-radius: 8px;
    }
    
    .dashboard-stats {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
    }
    
    .stat-item {
        text-align: center;
        margin-left: 20px;
        background: rgba(255, 255, 255, 0.2);
        padding: 10px 15px;
        border-radius: 8px;
    }
    
    .stat-value {
        display: block;
        font-size: 24px;
        font-weight: bold;
    }
    
    .stat-label {
        font-size: 12px;
        opacity: 0.8;
    }
    
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
    }
    
    .empty-state {
        padding: 40px 0;
        text-align: center;
        color: #9e9e9e;
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .pagination-container {
        margin-top: 20px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
        .dashboard-stats {
            justify-content: center;
            margin-top: 20px;
        }
        
        .action-buttons {
            flex-wrap: wrap;
        }
    }
</style>
{% endblock %} 